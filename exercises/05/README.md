# Lab 5: How to Query the State

Terraform's state is the way in which it is able to keep a cache of infrastructure configuration and its
mapping to terraform objects.  The state is used to store information that is generated by the actual resulting
infrastructure.  An example of this would be S3 buckets, EC2 instances, you name it; where the essential config is stored in the tf configuration files, but the IDs has to be generated by AWS.  After AWS generates these IDs, Terraform  would record this information in the state.

There are many reasons why you would want to query a state for information, either via CLI or using Terraform's interpolation.  We will experiment with 3 ways this can be done.

### Launch Infrastructure

1. First run the whole workflow on `other_project`

```bash
terraform init
terraform fmt
terraform validate
terraform apply
```

After that run the same on the main dir:

```bash
terraform init
terraform fmt
terraform validate
terraform apply
```

As we did not plan, we get asked if we wish to proceed! Notice the output after the `apply` has the element from the state file of the `other-project`

### Command Line

Terraform has a CLI command called "show", which allows users to export useful information from the state in a way 
that can be easily grep'ed or awk'ed.

```bash
terraform show
```

You should see something like this below:

```
# data.terraform_remote_state.other_project:
data "terraform_remote_state" "other_project" {
    backend = "local"
    config  = {
        path = "other_project/terraform.tfstate"
    }
    outputs = {
        bucket_name = "terraform-lab5--65495"
        common_tags = {
            Team    = "IT"
            company = "Globomantics"
        }
    }
}

# aws_s3_object.user_student_alias_object:
resource "aws_s3_object" "user_student_alias_object" {
    bucket                 = "terraform-lab5--65495"
    bucket_key_enabled     = false
    content                = "This bucket is reserved for axel"
    content_type           = "application/octet-stream"
    etag                   = "107ea5573280a0c5bf945f2e817664a7"
    force_destroy          = false
    id                     = "terraform-lab5-di"
    key                    = "terraform-lab5-di"
    server_side_encryption = "AES256"
    storage_class          = "STANDARD"
    tags                   = {
        "Team"    = "IT"
        "company" = "Globomantics"
    }
    tags_all               = {
        "Team"    = "IT"
        "company" = "Globomantics"
    }
}

# random_integer.rand:
resource "random_integer" "rand" {
    id     = "86921"
    max    = 99999
    min    = 10000
    result = 86921
}


Outputs:

other_project_bucket = "terraform-lab5--65495"
```

Maybe even more helpful, Terraform also supports outputting state in a more machine-readable way:

```bash
terraform show -json
```

Terraform stores state as json, so this is mostly just returning a very similar structure and set of values that you 
might find in your `terraform.tfstate` file as well, assuming you're using local state.

### Remote State Data Type

State is not always stored in a file local to the config. If you have another project's state file accessible, you can 
use the remote state data type to parse remote state with interpolation like everything else.  Within this directory,
there is  a folder called `other_project`.  This folder contains a Terraform project that has already generated resources,
and so it has a populated tfstate file for us to reference.  If you run the following in the current directory, you will
get an output from the statefile in `other_project`, not the rg created by this project.

```bash
terraform output other_project_bucket
```

If you got "terraform-lab5-65495" or similar then this worked successfully. Take some time you look at the usage of the remote_state data resource and how it's implemented in this exercise and play around with it a bit. Are you able to create another project and get outputs from that project?

### Direct JSON Parse

Since the tfstate files are just JSON files, given the appropriate level of motivation, you could parse it directly to get the information you need. We don't really consider this a feature of Terraform, but rather a side-effect of the way state files exist, so we won't be doing that in this exercise.

### Finishing this exercise

Let's run the following both on  current dir and `other_project` to finish:

```bash
terraform destroy
```
